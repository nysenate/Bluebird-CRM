<?php

define('BATCHSIZE', 250);
define('BATCHSIZETAG', 5000);
define("NYSSIODEBUG", TRUE);

require_once(dirname(__FILE__) . '/nyss_lib.php');
require_once(dirname(__FILE__) . '/nyss_io.php');

//define menu path
function nyss_io_menu () {

  $items = array();

  $items['importdata'] = array (
    'title' => t('Import Data'),
    'page callback' => 'nyss_ioimportdata_page',
    'access arguments' => array('import print production'),
    'type' => MENU_SUGGESTED_ITEM,
  );

  return $items;
}

//define page
function nyss_ioimportdata_page() {
  return drupal_get_form('nyss_ioimport_form');
}

//define form
function nyss_ioimport_form() {

  civicrm_initialize( );
  require_once 'CRM/Core/Config.php';
  require_once 'CRM/Core/DAO.php';

  $config = CRM_Core_Config::singleton();

  $form = array();

  //$form['#attributes'] = array('enctype' => "multipart/form-data");

  //Import and Main Processing
  $form['processing'] = array (
    '#type'          => 'fieldset',
    '#title'         => t('Import Source and Processing Options'),
  );

  $form['processing']['csv'] = array(
    '#type'          => 'file',
    '#title'         => t('Upload a file'),
    '#size'          => 40,
  );

  $form['processing']['servercsv'] = array(
    '#type'          => 'textfield',
    '#title'         => t('OR specify a filename on the server in the \'/data/importData\' dir'),
    '#size'          => 40,
  );

  $form['processing']['runnum'] = array(
    '#type'          => 'select',
    '#title'         => t('How many records to process in dry run mode (should be set to ALL for data import)'),
    '#options'       =>
    array(
      '10'   => t('10'),
      '100'  => t('100'),
      '500'  => t('500'),
      '1000' => t('1000'),
      'All'  => t('All'),
    ),
    '#default_value' => '10',
  );

  $form['processing']['dryrun'] = array(
    '#type'          => 'checkbox',
    '#title'         => t('Dry Run (parses data but does not alter the instance)'),
    '#default_value' => 1,
  );
   
  $form['processing']['sendemail'] = array(
    '#type'          => 'checkbox',
    '#title'         => t('Send summary email'),
    '#default_value' => 0,
  );

  //Dedupe Processing Options
  $form['dedupeset'] = array (
    '#type'          => 'fieldset',
    '#title'         => t('Dedupe Processing'),
  );

  $form['dedupeset']['dedupe'] = array(
    '#type'          => 'checkbox',
    '#title'         => t('Dedupe on import.'),
    '#default_value' => 0,
    '#description'   => t('When enabled, imported records will be compared and matched with existing contact records using the selected rule. Records should have first name, last name, suffix, street address, and postal code or email in order to effectively match.'),
  );

  $rules = CRM_Core_DAO::executeQuery("
    SELECT name, id
    FROM civicrm_dedupe_rule_group
    WHERE contact_type = 'Individual'
    ORDER BY name;");

  $dedupeoptions = array( );
  while ($rules->fetch()) {
    $dedupeoptions[$rules->id] = $rules->name;
  }
   
  $form['dedupeset']['deduperule'] = array(
    '#type'          => 'select',
    '#options'       => $dedupeoptions,
    '#title'         => t('Dedupe Rule'),
    '#default_value' => 1,
    '#description'   => t('If dedupe is enabled (above), select which rule to use when determining a match. In most cases you will use the Individual Strict rule.'),
  );
   
  //Data Handling Options
  $form['datahandling'] = array (
    '#type'          => 'fieldset',
    '#title'         => t('Data Handling'),
  );
   
  $form['datahandling']['boeimport'] = array(
    '#type'          => 'checkbox',
    '#title'         => t('Process as a BOE import.'),
    '#default_value' => 0,
    '#description'   => t(''),
  );
   
  $form['datahandling']['emailimport'] = array(
    '#type'          => 'checkbox',
    '#title'         => t('Process as an email import.'),
    '#default_value' => 0,
    '#description'   => t('Enabling will automatically engage dedupe on import using the email import rule. New contacts created during import (which do not match any existing contacts) will be added to an "Email Only" group and excluded from postal mailings.'),
  );
   
  $form['datahandling']['addtogroup_handling'] = array(
    '#type'          => 'radios',
    '#title'         => t('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add to Group Handling'),
    '#options'       => array( 'all' => t('Add All'), 'new' => t('Add New'), 'none' => t('None') ),
    '#attributes'    => array( 'class' => 'addtogroup_handling-wrapper' ),
    '#default_value' => 'none',
    '#description'   => t('If "Add All" is selected, all imported contacts will be added to the group. If "Add New" is selected, only new contacts created through the import will be added to the group.'),
  );
   
  $form['datahandling']['addtogroup'] = array(
    '#type'          => 'textfield',
    '#title'         => t('Group Name (if the group name does not exist, it will be created)'),
    '#size'          => 40,
    '#field_prefix'  => '<br />',
  );
   
  $form['datahandling']['parsename'] = array(
    '#type'          => 'checkbox',
    '#title'         => t('Parse full name'),
    '#default_value' => 0,
    '#description'   => t('Enable this option if your import file contains a full_name field that you want to parse into first/middle/last name. Note, if you enable this option, parsed field names will be ignored.'),
  );
   
  $form['datahandling']['fieldoverride'] = array(
    '#type'          => 'checkbox',
    '#title'         => t('Null/empty override'),
    '#default_value' => 0,
    '#description'   => t('Enabling this option will allow you to override existing fields with empty values. Standard behavior ignores empty values in your import file, thus retaining existing values in Bluebird. Use with caution.'),
  );

  $form['datahandling']['disablegreeting'] = array(
    '#type'          => 'checkbox',
    '#title'         => t('Disable Greeting Generation'),
    '#default_value' => 0,
    '#description'   => t('By default, postal/email/addressee greetings are generated for imported contacts that do not already have a value set (updated contacts with an existing value are skipped). Selecting this option will skip the greeting generation process and improve import performance.'),
  );

  $form['import']['submit'] = array(
    '#type'          => 'submit',
    '#value'         => t('Submit'),
  );

  return $form;
}

//define form validation
function nyss_ioimport_form_validate($form, &$form_state) {
  nyss_iovalidateuploadform($form, $form_state);
}

//process form validation steps
function nyss_iovalidateuploadform( $form, &$form_state ) {

  //require either a file be uploaded or referenced on the server
  if ( !empty($form_state['values']['servercsv']) ) {

    $form_state['values']['csv']['title'] = $form_state['values']['servercsv'];
    $form_state['values']['csv']['file']->uri = '/data/importData/'.$form_state['values']['servercsv'];
    if ( !file_exists($form_state['values']['csv']['file']->uri ) ) {
      form_set_error('servercsv', 'No file by that name was found.');
    }
  }
  else {
    $validators = array('file_validate_extensions' => array('csv tab txt'));
    $file = file_save_upload('csv', $validators);

    if (!$file) {
      form_set_error('csv', 'You must select a valid file to upload.');
    }
    else {
      // Manually add the uploaded file to the $form_state
      $form_state['values']['csv']['title'] = $file->filename;
      $form_state['values']['csv']['file']  = $file;
    }
  }
  //nyss_out('debug', $file, true); exit();
  //nyss_out('debug', $form_state, true); exit();
}

//main function for processing import
function nyss_ioimport_form_submit($form, &$form_state) {
  //nyss_out("debug", $form_state, TRUE);

  //track processing time
  $timeStart = time();

  // Load the configuration for this instance
  require_once dirname(__FILE__).'/../../civicrm/scripts/bluebird_config.php';
  $bbconfig = get_bluebird_instance_config();

  global $user;
  global $nyss_ioline;
  global $nyss_iototallines;
  global $nyss_conn;

  civicrm_initialize( );
  require_once 'CRM/Core/Config.php';
  $config = CRM_Core_Config::singleton();

  require_once 'CRM/Utils/String.php';
  require_once 'api/api.php';

  $nyss_conn = new CRM_Core_DAO();
  $nyss_conn = $nyss_conn->getDatabaseConnection();
  $nyss_conn = $nyss_conn->connection;

  $logpath = isset($bbconfig['nyss_io.log_path']) ? $bbconfig['nyss_io.log_path'] : '/data/importData/logs/';

  if ( !file_exists($logpath) ) {
    mkdir( $logpath, 0775, TRUE );
  }

  $logFilename = "import." . mt_rand(1,9999999999999999).".log";
  $logFilePath = $logpath.$logFilename;
  $logFile = fopen($logFilePath, 'w');

  require_once(dirname(__FILE__) . '/nyss_io_definitions.inc');

  $filename = $form_state['values']['csv']['file']->uri;
  if ( empty($filename) ) {
    nyss_out('status',"unable to find filename.",TRUE);
  }

  $fo = new nyss_iofileobject($filename, "\t");
  $nyss_iototallines = $fo->countLines();

  //initialize some values
  $bImportData = array();
  $nyss_ioline = 0;
  $runnum=$form_state['values']['runnum'];
  $dryrun=$form_state['values']['dryrun'];
  if (!$dryrun) $dryrun = false;

  $ioOptions = array();
  fillIoGetOptions($ioOptions);

  //get some civicrm values and flip so we can easily lookup values
  $aStates = array_flip(ioGetStates());
  $aGender = array_flip(ioGetOptions("gender", $ioOptions));
  $aPrefix = array_flip(ioGetOptions("individual_prefix", $ioOptions));
  $aSuffix = array_flip(ioGetOptions("individual_suffix", $ioOptions));
  $aLocTyp = array_flip(ioGetLocType());

  nyss_out( 'status',
    "importing file with dryrun=$dryrun AND count=$runnum.<br>Import file: {$filename}.<br>Log File: {$logFilename}",
    TRUE);

  //set includes based on column headers
  $columns = $fo->header;
  if ( array_key_exists('current_employer', $columns) ) {
    require_once 'CRM/Contact/BAO/Contact/Utils.php';
  }

  //include parsename helper if set
  $parse = $form_state['values']['parsename'];
  if ( $parse ) {
    require_once( dirname(__FILE__).'/nameparse.php' );
  }

  //if processing as an email import, set other required options
  if ($form_state['values']['emailimport']==1) {
    $form_state['values']['dedupe']     = 1;
    $form_state['values']['deduperule'] = 11;
  }

  //initialize arrays to be populated with contact id's during import
  $imported_contacts = array();
  $updated_contacts  = array();
  $new_contacts      = array();
  $addressDel        = array();
  $tagContacts       = array();

  $keyword_lookup = array();

  while ($l = $fo->getLine()) {

    if ($nyss_ioline%BATCHSIZE==0) {
      mysql_query("START TRANSACTION", $nyss_conn);
    }

    //nyss_out('debug', $l, TRUE); //exit();

    //seconds to process each row
    set_time_limit (30);

    //increase line number
    ++$nyss_ioline;

    if(is_numeric($runnum)) {
      if($form_state['values']['runnum']<=$nyss_ioline) {
        nyss_out('debug',"Stopping at {$nyss_ioline} lines.", TRUE);
        break;
      }
    }

    if ($nyss_ioline%500==0) nyss_out('status', "processed {$nyss_ioline} lines", TRUE);

    //fix the gender entries
    if ( !empty($l['gender']) ) {
      $gender_key = 'gender';
    }
    elseif ( !empty($l['gender_id']) ) {
      $gender_key = 'gender_id';
    }

    if (!empty($gender_key)) {
      if ($l[$gender_key]=='M') $l['gender'] = 'Male';
      if ($l[$gender_key]=='F') $l['gender'] = 'Female';
      $l['gender_id'] = $aGender[$l['gender']];
      unset($l['gender']); //remove text value
    }

    //fix birthdate
    if ( isset( $l['birth_date'] ) ) {
      $d = $l['birth_date'];
      if ( !empty($d) && $d != 0 && $d != 19000101 && $d != 19010101 && $d > 19000000 ) { //remove errant records
        $l['birth_date'] = substr($d,0,4).'-'.substr($d,4,2).'-'.substr($d,6,2);
      }
      else {
        $l['birth_date'] = NULL;
      }
    }

    //fix location_type_id if set and not numeric
    if ( isset($l['location_type_id']) && !is_numeric($l['location_type_id']) ) {
      $lti = $l['location_type_id'];
      $l['location_type_id'] = $aLocTyp[$lti];
    }

    //fix boe registration date
    if ( isset( $l['boe_date_of_registration_24'] ) ) {
      $boe_reg = $l['boe_date_of_registration_24'];
      if ( !empty($boe_reg) && $boe_reg != 0 && $boe_reg != 19000101 && $boe_reg != 19010101 ) { //remove errant records
        $l['boe_date_of_registration_24'] = substr($boe_reg,0,4).'-'.substr($boe_reg,4,2).'-'.substr($boe_reg,6,2);
      }
      else {
        $l['boe_date_of_registration_24'] = NULL;
      }
    }

    //4107 parse name
    if ( $parse && isset($l['full_name']) ) {
      $parsedValues = parse_name( $l['full_name'] );
      $l['prefix_id']   = $parsedValues['title'];
      $l['first_name']  = $parsedValues['first'];
      $l['middle_name'] = $parsedValues['middle'];
      $l['last_name']   = $parsedValues['last'];
      $l['suffix_id']   = $parsedValues['suffix'];

      //if parser found fname and no lname, we swap and assume it was an lname found
      if ( !empty($l['first_name']) && empty($l['last_name']) ) {
        $l['last_name']  = $l['first_name'];
        $l['first_name'] = '';
      }
    }

    //fix prefixes
    if ( isset( $l['prefix_id'] ) ) {
      $prefix_val = '';
      if ( array_key_exists( $l['prefix_id'], $aPrefix ) ) { //if a valid value, retain
        $prefix_val = $l['prefix_id'];
      }
      elseif ( array_key_exists( strtoupper($l['prefix_id']), $nyss_ioprefixes ) ) { //check if in prefix map
        $prefix_val = $nyss_ioprefixes[strtoupper($l['prefix_id'])];
      }
      else { //if odd, ignore
        $prefix_val = '';
      }
      $l['prefix_id'] = $aPrefix[$prefix_val];
    }

    //fix suffixes
    if ( isset( $l['suffix_id'] ) ) {
      if ( array_key_exists( $l['suffix_id'], $aSuffix ) ) { //if a valid value, retain
        $l['suffix_id'] = $aSuffix[$l['suffix_id']];
      }
      elseif ( array_key_exists( strtoupper($l['suffix_id']), $nyss_iosuffixes ) ) { //check if in suffix map
        $l['suffix_id'] = $aSuffix[$nyss_iosuffixes[strtoupper($l['suffix_id'])]];
      }
      else { //if odd, ignore
        $l['suffix_id'] = '';
      }
    }

    //set the last import timestamp if address fields are passed
    $addressExists = false;
    //$l['location_type_id'] = 6;
    foreach ( $nyss_iofields['civicrm_address'] as $field => $dontcare ) {
      if ( array_key_exists($field, $l) || $form_state['values']['fieldoverride'] ) {
        $l['last_import_57'] = date( 'Y-m-d H:i:s' );
        $addressExists = TRUE;
        break;
      }
    }

    //if dedupe selected and no contact id, lookup contact in db
    if ( $form_state['values']['dedupe'] && empty($l['id']) ) {
      require_once 'CRM/Dedupe/Finder.php';

      //format params to pass to dedupe tool
      $params = array();
      $params['civicrm_contact']['first_name']  = $l['first_name'];
      $params['civicrm_contact']['middle_name'] = $l['middle_name'];
      $params['civicrm_contact']['last_name']   = $l['last_name'];
      $params['civicrm_contact']['suffix_id']   = $l['suffix_id'];
      $params['civicrm_address']['postal_code'] = $l['postal_code'];

      if ( $l['street_address'] && !empty($l['street_address']) ) {
        $params['civicrm_address']['street_address'] = $l['street_address'];
      }
      else {
        $params['civicrm_address']['street_address'] = $l['street_number'].' '.$l['street_name'].' '.$l['street_unit'];
      }

      if ( array_key_exists('email',$l) && !empty($l['email']) ) {
        $params['civicrm_email']['email'] = $l['email'];
      }

      $params = CRM_Dedupe_Finder::formatParams($params, 'Individual');
      $params['check_permission'] = 0;

      $o = new stdClass();
      $o->name = 'Individual Strict (first + last + (street + zip | email))';
      $o->params = $params;
      $o->noRules = false;
      $tableQueries = array();
      $sql = nyss_dedupe_civicrm_dupeQuery($o, 'table', $tableQueries);
      $sql = $tableQueries['civicrm.custom.5'];
      $sql = "
        SELECT contact.id
        FROM civicrm_contact as contact JOIN ($sql) as dupes
        WHERE dupes.id1=contact.id AND contact.is_deleted=0";

      if (! $result = mysql_query($sql, $nyss_conn) ) {
        var_dump(mysql_error($nyss_conn)); exit();
      }

      $dupeIDs = array();
      while($row = mysql_fetch_assoc($result)) {
        $dupeIDs[] = $row['id'];
      }

      //if dupe found, set contact import id
      if ( is_array( $dupeIDs ) && !empty( $dupeIDs ) ) {
        $l['id'] = $dupeIDs[0];
      }

      //nyss_out('debug', $l, TRUE); exit();
    } //end dedupe lookup

    //look for existing related record in custom table
    if ( !empty($l['id']) ) {
      $sql = "
        SELECT id AS constinfo_id
        FROM civicrm_value_constituent_information_1
        WHERE entity_id = {$l['id']}";
      $result = mysql_query($sql, $nyss_conn);
      if($result && $row = mysql_fetch_assoc($result)) {
        $l['constinfo_id'] = $row['constinfo_id'];
      }
      mysql_free_result($result);
    }

    //process several fields for BOE imports
    if ( $form_state['values']['boeimport'] ) {
      //set all addresses as BOE type //TODO in future years should handle more intelligently
      $l['location_type_id'] = 6;

      //set contact source to BOE
      //TODO in future years we will preserve source on update if exists
      $l['contact_source_60'] = 'boe';

      //set voter registration status to registered
      $l['voter_registration_status_23'] = 'registered';
    } //end BOE processing

    //set state id
    if (!empty($l['st']) && !empty($aStates[$l['st']]) ) {
      $l['state_province_id'] = $aStates[$l['st']];
    }
    else if (!empty($l['state_province_id']) && !empty($aStates[$l['state_province_id']]) ) {
      $l['state_province_id'] = $aStates[$l['state_province_id']];
    }
    else {
      $l['state_province_id'] = "";
    }

    //if street_unit value exists, and there is no "apt" text, prepend to value
    if ( isset($l['street_unit']) && $l['street_unit'] ) {
      $needle_found = 0;
      $unit_needles = array ( 'apt', 'unit', 'super', 'sup', 'supt', 'ste', 'rm', 'pvt', 'fl', 'bsmt', 'lot' );
      foreach ( $unit_needles as $unit_needle ) {
        $needle_search = stripos( $l['street_unit'], $unit_needle );
        if ( $needle_search !== false ) {
          $needle_found = 1;
        }
      }
      if ( !$needle_found ) {
        $l['street_unit'] = 'Apt. '.$l['street_unit'];
      }
    }

    //form the street address if we are provided parsed values; convert proper case first
    if ( !empty($l['street_name']) ) {
      $so = convertProperCase( $l['street_number'], TRUE );
      $sn = convertProperCase( $l['street_name'], TRUE );
      $su = convertProperCase( $l['street_unit'], TRUE );
      $l['street_address'] = $so.' '.$sn;
      if ( $su ) {
        $l['street_address'] = $l['street_address'].', '.$su;
      }
    }
    elseif ( !empty($l['street_address']) ) {
      //else if we're provided street_address, send through parser
      require_once 'CRM/Core/BAO/Address.php';
      $parsedFields = CRM_Core_BAO_Address::parseStreetAddress( $l['street_address'] );
      //nyss_out('debug', $parsedFields, TRUE); exit();
      $l['street_number'] = $parsedFields['street_number'];
      $l['street_name']   = $parsedFields['street_name'];
      $l['street_unit']   = $parsedFields['street_unit'];
    }

    //if street_number set, let's parse into street_number and street_number_suffix
    //borrowed from CRM_Core_BAO_Address::parseStreetAddress()
    if ( isset($l['street_number']) && !empty($l['street_number']) ) {
      $streetNumAndSuffix = $l['street_number'];
      $matches = array( );
      if ( preg_match( '/^(\d+)/', $streetNumAndSuffix, $matches ) ) {
        $l['street_number'] = $matches[0];
        $suffix = preg_replace( '/^(\d+)/', '', $streetNumAndSuffix );
        $l['street_number_suffix'] = trim( $suffix );
        $matches = array( );
      }
    }

    //strip leading/trailing/double spaces for all imported data; escape all single quotes
    foreach ( $l as $k => $v ) {
      if (is_string($v)) {
        $v = CRM_Utils_String::stripSpaces($v);
      }
      $l[$k] = mysql_real_escape_string($v);
    }

    //identify addresses to be deleted and store for later processing
    //do before we perform an address_id lookup as we only want addresses
    //for which an ID was explicitly passed
    if ( !empty($l['address_id']) && strtolower($l['street_address']) == 'delete' ) {
      $addressDel[] = $l['address_id'];
    }

    //find an address if we don't have an addressID already
    if ( !empty($l['id']) && empty($l['address_id']) ) {
      $sql = "
        SELECT id AS address_id, is_primary AS address_is_primary
        FROM civicrm_address
        WHERE contact_id LIKE '{$l['id']}'
          AND street_number LIKE '{$l['street_number']}'
          AND street_name LIKE '{$l['street_name']}'
          AND city LIKE '{$l['city']}'
          AND ( postal_code LIKE '{$l['postal_code']}' OR postal_code LIKE '{$l['postal_code']}' )";
      $result = mysql_query($sql, $nyss_conn);
      if($result && $row = mysql_fetch_assoc($result)) {
        $l['address_id']         = $row['address_id'];
        $l['address_is_primary'] = $row['address_is_primary'];
        //reset primary flag here to prevent being overwritten by the import file
        //due to unexpected lookup/match with existing record
      }
      mysql_free_result($result);
    }

    //find district id if address id set
    if ( !empty($l['address_id']) && empty($l['districtinfo_id']) ) {
      $sql = "SELECT id AS districtinfo_id FROM civicrm_value_district_information_7 WHERE entity_id = {$l['address_id']}";
      $result = mysql_query($sql, $nyss_conn);
      if($result && $row = mysql_fetch_assoc($result)) {
        $l['districtinfo_id'] = $row['districtinfo_id'];
      }
      mysql_free_result($result);
    }

    //find email id if email is set
    if ( !empty($l['id']) && !empty($l['email']) && empty($l['email_id']) ) {
      $sql = "SELECT id AS email_id FROM civicrm_email WHERE email = '{$l['email']}' AND contact_id = {$l['id']}";
      $result = mysql_query($sql, $nyss_conn);
      if($result && $row = mysql_fetch_assoc($result)) {
        $l['email_id'] = $row['email_id'];
      }
      mysql_free_result($result);
    }

    //nyss_out('debug', 'ready to begin importing record...', TRUE);
    //nyss_out('debug', $l, TRUE); exit();

    /*------NOW IMPORT THE DATA-------------------------------------*/

    //import contact details
    $new_contact = (!array_key_exists('id',$l) || empty($l['id']));
    nyss_ioimportData('civicrm_contact', $l, $dryrun, $logFile, $form_state);

    //sort the contacts into groups for later use
    if (!$dryrun) {
      $imported_contacts[] = $l['id'];
      if ($new_contact)
        $new_contacts[] = $l['id'];
      else
        $updated_contacts[] = $l['id'];
    } else {
      $imported_contacts[] = 0;
      if ($new_contact)
        $new_contacts[] = 0;
      else
        $updated_contacts[] = 0;
    }

    //import address details
    //set key correctly for ref
    $l['contact_id']=$l['id'];
    if ( $addressExists ) {
      nyss_ioimportData('civicrm_address', $l, $dryrun, $logFile, $form_state);
    }

    //import phone details
    //set key correctly for ref
    $l['phone_contact_id']=$l['contact_id'];
    nyss_ioimportData('civicrm_phone', $l, $dryrun, $logFile, $form_state);

    //import email details
    //set key correctly for ref
    $l['email_contact_id']=$l['contact_id'];
    nyss_ioimportData('civicrm_email', $l, $dryrun, $logFile, $form_state);

    //import contact source details
    //set key correctly for ref
    $l['constinfo_entity_id'] = $l['id'];
    nyss_ioimportData('civicrm_value_constituent_information_1', $l, $dryrun, $logFile, $form_state);

    //import district details
    //set key correctly for ref (ID is for addresses)
    $l['entity_id'] = $l['address_id'];
    nyss_ioimportData('civicrm_value_district_information_7', $l, $dryrun, $logFile, $form_state);

    //process special fields using API/BAO
    //echo 'now begin processing special fields:<br />';
    if ( array_key_exists( 'current_employer', $l ) && !empty($l['current_employer']) ) {
      $sql = sprintf("
        SELECT c.id
        FROM civicrm_contact c
        WHERE c.organization_name = %s
          AND c.contact_type = 'Organization'
          AND is_deleted = 0
        LIMIT 1", mysql_real_escape_string($l['current_employer'], $nyss_conn));
      $result = mysql_query($sql, $nyss_conn);
      if ( $result && $row = mysql_fetch_assoc($result) ) {
        $current_employer = $row['orgID'];
      }
      else {
        $current_employer = convertProperCase($l['current_employer']);
      }
      if ( $dryrun ) {
        nyss_out('debug', $current_employer, TRUE);
      }
      else {
        $organization = CRM_Contact_BAO_Contact_Utils::createCurrentEmployerRelationship( $l['id'], $current_employer );
      }
      mysql_free_result($result);
    }

    //pipe separated list of keywords
    if ( array_key_exists( 'keywords', $l ) && !empty($l['keywords']) ) {
      $keywords = explode( '|', str_replace('| ', '|', str_replace('"', '', $l['keywords'])) );
      foreach ( $keywords as $keyword ) {
        $tagContacts[$keyword][] = $l['id'];
      }
    }

    if ( array_key_exists( 'note', $l ) && !empty($l['note']) ) {
      $params = array(
        'version'       => 3,
        'entity_table'  => 'civicrm_contact',
        'entity_id'     => $l['id'],
        'note'          => $l['note'],
        'contact_id'    => $l['id'],
        'modified_date' => date('Ymd'),
        'subject'       => 'Import Note',
      );
      if ( $dryrun ) {
        nyss_out('debug', $l['note'], TRUE);
      }
      else {
        $note = civicrm_api('note', 'create', $params );
      }
    }

    if ($nyss_ioline%BATCHSIZE==0) {
      mysql_query("COMMIT", $nyss_conn);
    }
  } //end record processing

  // Commit any straglers!
  if ($nyss_ioline%BATCHSIZE!=0) {
    mysql_query("COMMIT", $nyss_conn);
  }

  //Begin post process

  //Handle tag processing
  if ( !$dryrun ) {
    if ( !empty($tagContacts) ) {
      //make sure entity_tag table is clean and index exists
      checkTagIndex();

      $tagStart = time();
      foreach ( $tagContacts as $keyword => $tContacts ) {
        if (empty($keyword_lookup[$keyword])) {
          $params = array(
            'version'   => 3,
            'name'      => $keyword,
            'parent_id' => '296'
          );
          $tag = civicrm_api('tag', 'get', $params);

          if ( $tag['is_error'] || !$tag['count'] ) {
            echo 'creating tag: '.$keyword.'<br />';
            $tag   = civicrm_api('tag', 'create', $params);
          }
          $tagid = $tag['id'];
          $keyword_lookup[$keyword] = $tagid;
        }
        else {
          $tagid = $keyword_lookup[$keyword];
        }
        //CRM_Core_Error::debug_var('tagid',$tagid);

        //create sql insert; process in batches
        $eTList    = array();
        $eTSqlList = '';
        $b         = 0; //batch count
        $tagCount  = count($tContacts);

        foreach ( $tContacts as $i => $cid ) {
          $eTList[] = "'civicrm_contact', $cid, $tagid";
          if ( ( $i%BATCHSIZETAG == 0 && $i !== 0 ) ||
               $i == $tagCount - 1 ) {

            $entityTagStart = time();

            $eTSql  = 'INSERT IGNORE INTO civicrm_entity_tag ( entity_table, entity_id, tag_id ) VALUES (';
            $eTSql .= implode('), (', $eTList);
            $eTSql .= ');';
            CRM_Core_DAO::executeQuery($eTSql);

            //free memory
            unset($eTList);
            $eTList = array();

            $entityTagEnd  = time();
            $entityTagDiff = $entityTagEnd - $entityTagStart;

            nyss_out('debug', "tag: $keyword | set: $b | record: $i | processing time: $entityTagDiff secs.", TRUE);
            $b++;
          }
        }
      }
      $tagEnd  = time();
      $tagDiff = $tagEnd - $tagStart;
      nyss_out('debug', "tag processing time: $tagDiff secs.", TRUE);
    }
  }
  else {
    nyss_out('debug', $tagContacts, TRUE);
  }
  //end tags

  //Add contacts to group if set
  if ( !empty($form_state['values']['addtogroup']) &&
       $form_state['values']['addtogroup_handling'] != 'none' ) {

    //retrieve group if exists
    $groupID   = '';
    $groupName = $form_state['values']['addtogroup'];
    $params    = array(
      'version' => 3,
      'title' => $groupName
    );
    $group = civicrm_api('group', 'getsingle', $params);
    //CRM_Core_Error::debug_var('get group',$group);

    if ( $group['is_error'] ) {
      if (!$dryrun ) {
        $params = array(
          'version'   => 3,
          'title'     => $groupName,
          'is_active' => 1,
        );
        $groupNew = civicrm_api('group', 'create', $params);
        $groupID  = $groupNew['id'];
        nyss_out('status', "The {$groupName} group did not exist; it was created during import.", TRUE);
      }
      else {
        nyss_out('status', "The {$groupName} group does not exist; it will be created during import.", TRUE);
      }
    }
    else {
      $groupID = $group['id'];
    }

    //now prepare array for adding contacts to group
    $params = array(
      'version'  => 3,
      'group_id' => $groupID,
    );

    //construct the list of contacts to add
    switch ($form_state['values']['addtogroup_handling']) {
      case 'all' :
        $groupContacts = $imported_contacts;
        break;
      case 'new' :
        $groupContacts = $new_contacts;
        break;
      default:
        $groupContacts = '';
        break;
    }
    foreach($groupContacts as $i => $contact_id) {
      if ($i == 0)
        $params['contact_id'] = $contact_id;
      else
        $params["contact_id.$i"] = $contact_id;
    }
    //CRM_Core_Error::debug_var('create group_contact params',$params);

    if (!$dryrun) {
      $gc = civicrm_api( 'group_contact', 'create', $params );
    }

    $groupContactsCount = count($groupContacts);
    nyss_out('status', "Adding {$groupContactsCount} to the {$groupName} group.", TRUE);
  } //end add to group

  //Add all new contacts to the email only group
  if ( $form_state['values']['emailimport'] == 1 ) {

    //Create the group if it doesn't already exist
    $emailGroupID = '';
    $params       = array(
      'version' => 3,
      'name'    => 'Email_Only',
    );
    $emailGroup = civicrm_api('group', 'getsingle', $params);
    if ( $emailGroup['is_error'] ) {
      if (!$dryrun ) {
        $params = array(
          'version'     => 3,
          'title'       => 'Email Only',
          'is_active'   => 1,
          'description' => 'Contacts in this group will be excluded from postal mailings processed through Corporate Woods, and may be exclude from internal exports using the print processing option.' );
        $emailGroup = civicrm_api( 'group', 'create', $params );
        nyss_out('status', "The 'Email Only' group did not exist; it was created during import.", TRUE);
      } else {
        nyss_out('status',"The 'Email Only' group does not exist; it will be created during import.",TRUE);
      }
    }
    $emailGroupID = $emailGroup['id'];

    //add all the contacts to the email only group
    $params = array(
      'version'  => 3,
      'group_id' => $emailGroupID,
    );

    //construct the list of contacts to add to groups
    foreach($new_contacts as $i => $contact_id) {
      if ($i == 0)
        $params['contact_id'] = $contact_id;
      else
        $params["contact_id.$i"] = $contact_id;
    }

    //we also need to set these new contacts to 'do_not_mail'
    $new_contacts_list = ( !empty($new_contacts) ) ? implode( ',', $new_contacts ) : 0;
    $setDNM = "UPDATE civicrm_contact SET do_not_mail = 1 WHERE id IN ( $new_contacts_list );";

    if ( !$dryrun ) {
      // Create the GroupContact joins for each of these contacts
      $emailGroupContact = civicrm_api('group_contact', 'create', $params);

      //set do not mail
      mysql_query($setDNM, $nyss_conn);
    }
    $newContactsCount = count($new_contacts);
    nyss_out('status', "Adding {$newContactsCount} to the Email Only group", TRUE);
  }//end add to email only group

  //delete addresses flagged for deletion
  $addressDelCount = count($addressDel);
  if ( !empty($addressDel) && !$dryrun ) {
    $addressDelList  = implode( ',', $addressDel );
    $sqlAD = "
      DELETE FROM civicrm_address
      WHERE id IN ( $addressDelList );";
    mysql_query($sqlAD, $nyss_conn);
  }

  if ( $form_state['values']['sendmail']==1 ) {
    //now send a confirmation email
    $message = array(
      'to'      => $user->mail,
      'subject' => 'import Data Summary'.Date("Y-m-d H:i:s"). " filename: {$filename}",
      'body'    => 'download the import report here: '.urlencode( "http://".$_SERVER['HTTP_HOST'].'/nyss_getfile?file='.urlencode($filename)),
      'headers' => array('From' => 'import@cms.nysenate.gov'),
    );
    drupal_mail_send($message);
  }

  $num_updated = count($updated_contacts);
  $num_created = count($new_contacts);

  nyss_out('status',"$num_updated updated, $num_created created.", TRUE);
  nyss_out('status',"$addressDelCount addresses deleted.", TRUE);
  nyss_out('status',"Imported $nyss_ioline lines. access the log file <a href=\"http://".$_SERVER['HTTP_HOST'].'/nyss_getfile?file='.urlencode($logFilename)."\">click here.</a>",TRUE);

  //various postProcessing cleanup steps
  if ( !$dryrun ) {
    $bbconfig = get_bluebird_instance_config();

    //run duplicate primary flag cleanup
    $dupePriScript = $bbconfig['app.rootdir'].'/scripts/fixDupePrimary.sh '.$bbconfig['shortname'];
    $dupePriCleanup = shell_exec( $dupePriScript );
    nyss_out('status', $dupePriCleanup, TRUE);

    //run greetings update on all null values unless disable greeting option is selected
    if ( !$form_state['values']['disablegreeting'] ) {
      $greetingScript = 'php '.$bbconfig['app.rootdir'].'/civicrm/scripts/updateAllGreetings.php -S '.$bbconfig['shortname'];
      $greetingCreate = shell_exec( $greetingScript );
      nyss_out('status', $greetingCreate, TRUE);
    }

    //check for malformed emails and place on hold
    $flagEmailScript  = $bbconfig['app.rootdir'].'/scripts/flagBadEmails.sh --ok '.$bbconfig['shortname'];
    $flagEmailCleanup = shell_exec( $flagEmailScript );
    nyss_out('status', $flagEmailCleanup, TRUE);
  }

  //track processing time
  $timeEnd  = time();
  $timeDiff = $timeEnd - $timeStart;
  nyss_out('status',"Processing time: $timeDiff sec.",TRUE);
  nyss_out('status','<a href="">click here</a> to continue and return to the import page.',TRUE);

  exit();
}

function nyss_ioimportData( $tbl, &$l, $dryrun, $logFile, $form_state ) {

  //nyss_out('debug', "tbl top: $tbl", TRUE);
  //nyss_out('debug', $l, TRUE);

  global $nyss_iofields;
  global $nyss_select;
  global $nyss_ioline;
  global $nyss_conn;

  //build the select array once and store global for efficiency
  if ( empty($nyss_select) ) {
    $nyss_select = array();
    foreach ( $nyss_iofields as $table=>$tableDetails ) {
      $tmp = array();
      foreach ($tableDetails as $key=>$importField) {
        $tmp[] = "`{$importField['fld']}` as '{$key}'";
        if (isset($importField['PK']) && $importField['PK']) {
          $nyss_select[$table]['PK']['importField'] = $key;
          $nyss_select[$table]['PK']['civiField'] = $importField['fld'];
        }
      }
      $nyss_select[$table]['fields'] = implode(",",$tmp);
    }
  }
    
  $pkCivi = $nyss_select[$tbl]['PK']['civiField'];
  $pkImport = $nyss_select[$tbl]['PK']['importField'];

  //nyss_out('debug', $nyss_select, TRUE);
  //nyss_out('debug', "pkCivi: $pkCivi", TRUE);
  //nyss_out('debug', "pkImport: $pkImport", TRUE);
  //nyss_out('debug', "fields: {$nyss_select[$tbl]['fields']}", TRUE);
  //nyss_out('debug', $l, TRUE);

  //if we are being passed a key, this is going to be an update
  //otherwise it's an insert
  if ( !empty($l[$pkImport]) ) {
    //nyss_out('status', 1, TRUE);
    //nyss_out('debug', $pkCivi, TRUE);
    //nyss_out('debug', $pkImport, TRUE);
    //nyss_out('debug', $l, TRUE);

    //get the existing data
    $sql = "SELECT ".$nyss_select[$tbl]['fields']." FROM {$tbl} WHERE {$pkCivi}={$l[$pkImport]}";

    $result = mysql_query($sql, $nyss_conn);

    $dao = new stdClass();
    if ( !$result || mysql_num_rows($result) == 0) {
      nyss_out('error','no civirecord found. not importing.',TRUE);
    }
    else {
      $dao = mysql_fetch_object($result);
    }

    mysql_free_result($result);

    $up = array();
    
    //compare the fields
    foreach( $l as $key=>$data ) {

      //apply handler if set
      if ( isset($nyss_iofields[$tbl][$key]['handler']) ) {
        $data = $nyss_iofields[$tbl][$key]['handler']($data, TRUE);
      }

      //echo 'existing: '.$dao->$key.'<br />';
      //echo 'new: '.$data.'<br /><br />';
      //if the import data doesn't match civi data, update it
      if ( isset($nyss_iofields[$tbl][$key]) &&
           ( $dao->$key<>$data || $form_state['values']['fieldoverride'] )
         ) {

        //add to the update statement
        if ( !empty($data) || $form_state['values']['fieldoverride'] ) {
          if ( empty($data) ) {
            $up[] = "{$nyss_iofields[$tbl][$key]['fld']}=NULL";
          }
          else {
            $up[] = "{$nyss_iofields[$tbl][$key]['fld']}='{$data}'";
          }
        }

        //if address is being updated, set lat/lon to null for reprocessing
        if ( $key = 'street_address' &&
             ( empty($l['geo_code_1']) || empty($l['geo_code_2']) ) ) {
          $l['geo_code_1'] = NULL;
          $l['geo_code_2'] = NULL;
        }
      }
    }

    //if there is something to update, do it!
    if (!empty($up)) {
      $sqlUP = "UPDATE {$tbl} SET ".implode(',',$up). " WHERE {$pkCivi}={$l[$pkImport]}";
      //print_r($sqlUP."<br>");

      if ( !$dryrun ) {
        mysql_query($sqlUP, $nyss_conn);
      }
      else {
        //if ($tbl=='civicrm_value_constituent_information_1' || $tbl=='civicrm_value_district_information_7') {
        print_r($sqlUP."<br>"); //debug
        //}
      }
      fwrite($logFile, "line {$nyss_ioline}: updated record. " . $sqlUP. "\n");
    }
    else {
      fwrite($logFile, "line {$nyss_ioline}: nothing to update for $tbl record: " . implode(',',$l). "\n");
    }
  }
  //otherwise just insert
  else {
    $skip = false;
    $sqlINSERT  = "";
    $insertKeys = array();

    //nyss_out('debug', $l, TRUE);
    $up = array();

    //first set a few additional values required for insert action
    require_once 'CRM/Utils/String.php';
        
    //contact record work
    if ( $tbl == 'civicrm_contact' ) {
      $l['contact_type'] = 'Individual';
      $prefixes = ioGetOptions("individual_prefix", $ioOptions);
      $suffixes = ioGetOptions("individual_suffix", $ioOptions);
      $suffix = ( !empty($l['suffix_id']) && !empty($suffixes[$l['suffix_id']]) ) ? ', '.$suffixes[$l['suffix_id']] : '';
      $l['middle_name'] = ( !empty($l['mid']) ) ? $l['mid'] : $l['middle_name']; //account for both possible field names
      //need to propercase these values before constructing display and sort name
      $fnc = trim(convertProperCase( $l['first_name'], TRUE ));
      $mnc = trim(convertProperCase( $l['middle_name'], TRUE ));
      $fnc = ( $mnc ) ? $fnc.' ' : $fnc;
      $lnc = trim(convertProperCase( $l['last_name'], TRUE ));
      $prefix = ( !empty($l['prefix_id']) && !empty($prefixes[$l['prefix_id']]) ) ? $prefixes[$l['prefix_id']] : '';
      $display_name = $prefix.' '.$fnc.$mnc.' '.$lnc.$suffix;
      $l['display_name'] = nyss_stripSpaces( $display_name );
      if ( !empty($l['display_name']) ) $l['sort_name'] = $lnc.', '.$fnc.$mnc.$suffix;
    }
        
    //only set these if the corresponding data columns exist in the import file
    //nyss_out('debug', $l, TRUE);
    if ( ( array_key_exists('street_address', $l) && !empty($l['street_address']) ) ||
         ( array_key_exists('supplemental_address_1', $l) && !empty($l['supplemental_address_1']) ) ) {
      if ( $form_state['values']['boeimport'] ) {
        $l['location_type_id'] = 6; //set address type to BOE
      }
      elseif ( empty($l['location_type_id']) || !array_key_exists('location_type_id', $l) ) {
        $l['location_type_id'] = 1; //set address type to Home if not set by importer
      } //else use as set in the import file

      if ( !array_key_exists('address_is_primary', $l) ) {
        $l['address_is_primary'] = 1; //set to primary
      }
      $l['country_id'] = 1228; //assume US
    }
    if ( array_key_exists('phone', $l) ) {
      $l['phone_type_id'] = 1; //set to phone
      if ( empty($l['phone_location_type_id']) ) {
        $l['phone_location_type_id'] = 1; //set to home
      }
      if ( empty($l['phone_is_primary']) ) {
        $l['phone_is_primary'] = 1; //set to primary
      }
    }
    else {
      //if no phone value, unset the contact_id so empty record is not created; TODO: handle higher in the process
      unset($l['phone_contact_id']);
    }

    if ( array_key_exists('email', $l) ) {
      if ( !$l['email_location_type_id'] ) {
        $l['email_location_type_id'] = 1; //set to home
      }
      if ( !$l['email_is_primary'] ) {
        $l['email_is_primary'] = 1; //set to primary
      }
    }
    else {
      //if no email value, unset the contact_id so empty record is not created; TODO: handle higher in the process
      unset($l['email_contact_id']);
    }

    //nyss_out('debug', $tbl, TRUE);
    //nyss_out('debug', $l, TRUE); //exit();
        
    //set up the insert
    //nyss_out('status', 'set up the insert', TRUE);
    foreach($l as $key=>$data) {

      //unset if no data
      if ( empty($data) && $data !== 0 && array_key_exists($key, $nyss_iofields[$tbl]) ) {
        unset($l[$key]);
        continue;
      }

      //apply handler if set
      if(isset($nyss_iofields[$tbl][$key]['handler'])) $data = $nyss_iofields[$tbl][$key]['handler']($data, TRUE);

      //make sure we're only processing the records for that table
      if (!isset($nyss_iofields[$tbl][$key])) continue;
      //echo 'field to be processed: ';
      //nyss_out('debug', $key, TRUE);
      $up = array();

      //skip if required values not found
      if (empty($data) && $nyss_iofields[$tbl][$key]['required']) {
        $skip=TRUE;
        break;
      }

        //skip if no data
      if ( empty($data) && $data !== 0 ) continue;

      //removed as we handle escaping earlier in the script
       //$data = str_replace("'","\'",$data);

      $insertKeys[] = "`{$nyss_iofields[$tbl][$key]['fld']}`";
      $insertData[] = "'{$data}'";
    }
        
    //nyss_out('debug', $l, TRUE); exit();

    if ($skip) return;

    if ( $insertKeys && $insertData ) {
      $sqlINSERT = "INSERT INTO {$tbl} (".implode(',',$insertKeys).") VALUES (".implode(',',$insertData).")";
      //nyss_out('debug', $sqlINSERT, TRUE); exit();
    }

    //process if sql insert exists and not dryrun
    if ( !$dryrun && $sqlINSERT ) {
      mysql_query($sqlINSERT, $nyss_conn);
      $l[$pkImport]=mysql_insert_id($nyss_conn);
    }
    elseif ( $sqlINSERT ) {
      //if ($tbl=='civicrm_value_constituent_information_1') {
      print_r($sqlINSERT."<br>"); //debug
      //}
    }

    fwrite($logFile, "line {$nyss_ioline}: inserted record. " . $sqlINSERT . "\n");
  }
}

function fillIoGetOptions(&$ioOptions)
{
  $session = & CRM_Core_Session::singleton();
  $dao = &CRM_Core_DAO::executeQuery("SELECT id, name FROM civicrm_option_group;");

  $optionGroups = array();
  while($dao->fetch())
  {
    $optionGroups[$dao->id] = $dao->name;
  }

  $dao = &CRM_Core_DAO::executeQuery("SELECT id, option_group_id, name, label, value FROM civicrm_option_value");
  $options = array();
  while($dao->fetch())
  {
    $name = (strlen($dao->label) > 0) ? $dao->label : $dao->name;
    $options[$optionGroups[$dao->option_group_id]][$dao->value] = $name;
  }
  $ioOptions = $options;
}

function ioGetOptions($strGroup, &$ioOptions)
{
  if(isset($ioOptions[$strGroup]) && !is_null($ioOptions[$strGroup]) && is_array($ioOptions[$strGroup]))
    return $ioOptions[$strGroup];
  return array();
}

function ioGetStates()
{
  $session =& CRM_Core_Session::singleton();

  $dao = CRM_Core_DAO::executeQuery("
      SELECT id, abbreviation
      FROM civicrm_state_province
      WHERE country_id = 1228",
    CRM_Core_DAO::$_nullArray); //lookup US states only

  $options = array();

  while ($dao->fetch()) {
    $options[$dao->id] = $dao->abbreviation;
  }

  return $options;
} // ioGetStates()

function ioGetLocType()
{
  $session =& CRM_Core_Session::singleton();
  $dao = &CRM_Core_DAO::executeQuery("SELECT id, name FROM civicrm_location_type;", CRM_Core_DAO::$_nullArray);
  $options = array();
  while ($dao->fetch()) {
    $options[$dao->id] = $dao->name;
  }
  return $options;
} // ioGetLocType()

function convertProperCase( $string, $skipMixed = FALSE, $skipSpecial = FALSE ) {

  require_once 'CRM/Utils/String.php';

  //if mixed case, don't do anything
  if ($skipMixed && preg_match('/[a-z]/', $string)) return $string;

  $string = CRM_Utils_String::stripSpaces( ucwords(strtolower($string)) );

  //if we skip special words processing, return now
  if ($skipSpecial) return $string;

  // list of words we want to force
  $forceWords = array(
    'of', 'the', 'and', 'an', 'or', 'nor', 'but', 'is', 'if', 'then',
    'else', 'when', 'at', 'from', 'by', 'on', 'off', 'for', 'in', 'out', 'over', 'to',
    'into', 'with', 'II', 'IV', 'UK', 'VI', 'III', 'VII', 'PO', 'McDonald', 'McClelland', 'RR'
  );

  // punctuation used to determine that the following letter
  // should be capitalised
  $punctuation = array(
    '.', '-', ':', '!', '\'', '-', '?'
  );

  $words = explode(' ', $string);

  foreach ($words as $word) {

    $replace = array();

    //trim any non-word chars and replace with nothing for easier matching
    $cleanWord = preg_replace("/[^\w]/", '', $word);
    //nyss_out('debug', "cleanWord: $cleanWord", TRUE);
    if (!empty($cleanWord)) $replace = preg_grep( "/\b{$cleanWord}\b/i", $forceWords);

    $replace = array_values($replace);
    //nyss_out('debug', $replace, TRUE);
    if (isset($replace[0])) $word = str_replace($cleanWord,$replace[0],$word);

    //if number followed by letter, uppercase
    if ( preg_match("/^\d[a-z]/", $cleanWord) ) {
      $word = strtoupper(($word));
    }

    $fixedWords[] = $word;
  }

  //nyss_out('debug', $fixedWords, TRUE);
  $string = implode(' ',$fixedWords);

  return $string;
}

function checkTagIndex() {

  $sql = "
    SHOW INDEX FROM civicrm_entity_tag
    WHERE Key_name = 'index_civicrm_entity_tag_entity_table_entity_id_tag_id'";
  $ti  = CRM_Core_DAO::singleValueQuery($sql);

  if ( !$ti ) {
    //remove duplicates and add index
    $bbconfig = get_bluebird_instance_config();

    //run duplicate primary flag cleanup
    $fixET = $bbconfig['app.rootdir'].'/scripts/fixEntityTags.sh --dups-only --ok '.$bbconfig['shortname'];
    $fixETout = shell_exec( $fixET );
    nyss_out('status', $fixETout, TRUE);

    //create index
    $sql = "
      ALTER TABLE civicrm_entity_tag
      ADD UNIQUE index_civicrm_entity_tag_entity_table_entity_id_tag_id
        ( entity_table, entity_id, tag_id ) ";
    $ind = CRM_Core_DAO::executeQuery($sql);
    nyss_out('status', 'index_civicrm_entity_tag_entity_table_entity_id_tag_id created', TRUE);
  }

  return;
}
